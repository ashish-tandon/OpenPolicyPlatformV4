# Fluentd configuration for Open Policy Platform
# Collects logs from all services and forwards to local files

<source>
  @type forward
  port 24224
  bind 0.0.0.0
</source>

<source>
  @type http
  port 9880
  bind 0.0.0.0
</source>

# Collect logs from Docker containers via Docker logging driver
<source>
  @type tail
  path /var/lib/docker/containers/*/*-json.log
  pos_file /fluentd/log/docker-containers.log.pos
  tag docker.*
  read_from_head true
  <parse>
    @type json
    time_key time
    time_format %Y-%m-%dT%H:%M:%S.%L
    time_type string
  </parse>
</source>

# Filter and parse service logs
<filter docker.**>
  @type parser
  key_name log
  <parse>
    @type regexp
    expression /^(?<timestamp>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}.\d{3}Z)\s+(?<level>\w+)\s+(?<service>\w+)\s+(?<message>.*)$/
  </parse>
</filter>

# Add service metadata
<filter docker.**>
  @type record_transformer
  <record>
    service_name ${tag_parts[1]}
    environment production
    platform openpolicy
    hostname ${hostname}
  </record>
</filter>

# Write to local log files by service
<match docker.api-gateway.**>
  @type file
  path /fluentd/log/services/api-gateway
  append true
  <format>
    @type json
  </format>
  <buffer>
    @type memory
    flush_interval 1s
  </buffer>
</match>

<match docker.config-service.**>
  @type file
  path /fluentd/log/services/config-service
  append true
  <format>
    @type json
  </format>
  <buffer>
    @type memory
    flush_interval 1s
  </buffer>
</match>

<match docker.auth-service.**>
  @type file
  path /fluentd/log/services/auth-service
  append true
  <format>
    @type json
  </format>
  <buffer>
    @type memory
    flush_interval 1s
  </buffer>
</match>

<match docker.policy-service.**>
  @type file
  path /fluentd/log/services/policy-service
  append true
  <format>
    @type json
  </format>
  <buffer>
    @type memory
    flush_interval 1s
  </buffer>
</match>

<match docker.notification-service.**>
  @type file
  path /fluentd/log/services/notification-service
  append true
  <format>
    @type json
  </format>
  <buffer>
    @type memory
    flush_interval 1s
  </buffer>
</match>

<match docker.analytics-service.**>
  @type file
  path /fluentd/log/services/analytics-service
  append true
  <format>
    @type json
  </format>
  <buffer>
    @type memory
    flush_interval 1s
  </buffer>
</match>

<match docker.monitoring-service.**>
  @type file
  path /fluentd/log/services/monitoring-service
  append true
  <format>
    @type json
  </format>
  <buffer>
    @type memory
    flush_interval 1s
  </buffer>
</match>

<match docker.etl-service.**>
  @type file
  path /fluentd/log/services/etl-service
  append true
  <format>
    @type json
  </format>
  <buffer>
    @type memory
    flush_interval 1s
  </buffer>
</match>

<match docker.scraper-service.**>
  @type file
  path /fluentd/log/services/scraper-service
  append true
  <format>
    @type json
  </format>
  <buffer>
    @type memory
    flush_interval 1s
  </buffer>
</match>

<match docker.search-service.**>
  @type file
  path /fluentd/log/services/search-service
  append true
  <format>
    @type json
  </format>
  <buffer>
    @type memory
    flush_interval 1s
  </buffer>
</match>

<match docker.dashboard-service.**>
  @type file
  path /fluentd/log/services/dashboard-service
  append true
  <format>
    @type json
  </format>
  <buffer>
    @type memory
    flush_interval 1s
  </buffer>
</match>

<match docker.files-service.**>
  @type file
  path /fluentd/log/services/files-service
  append true
  <format>
    @type json
  </format>
  <buffer>
    @type memory
    flush_interval 1s
  </buffer>
</match>

<match docker.reporting-service.**>
  @type file
  path /fluentd/log/services/reporting-service
  append true
  <format>
    @type json
  </format>
  <buffer>
    @type memory
    flush_interval 1s
  </buffer>
</match>

<match docker.workflow-service.**>
  @type file
  path /fluentd/log/services/workflow-service
  append true
  <format>
    @type json
  </format>
  <buffer>
    @type memory
    flush_interval 1s
  </buffer>
</match>

<match docker.integration-service.**>
  @type file
  path /fluentd/log/services/integration-service
  append true
  <format>
    @type json
  </format>
  <buffer>
    @type memory
    flush_interval 1s
  </buffer>
</match>

<match docker.data-management-service.**>
  @type file
  path /fluentd/log/services/data-management-service
  append true
  <format>
    @type json
  </format>
  <buffer>
    @type memory
    flush_interval 1s
  </buffer>
</match>

<match docker.representatives-service.**>
  @type file
  path /fluentd/log/services/representatives-service
  append true
  <format>
    @type json
  </format>
  <buffer>
    @type memory
    flush_interval 1s
  </buffer>
</match>

<match docker.plotly-service.**>
  @type file
  path /fluentd/log/services/plotly-service
  append true
  <format>
    @type json
  </format>
  <buffer>
    @type memory
    flush_interval 1s
  </buffer>
</match>

<match docker.mobile-api.**>
  @type file
  path /fluentd/log/services/mobile-api
  append true
  <format>
    @type json
  </format>
  <buffer>
    @type memory
    flush_interval 1s
  </buffer>
</match>

<match docker.legacy-django.**>
  @type file
  path /fluentd/log/services/legacy-django
  append true
  <format>
    @type json
  </format>
  <buffer>
    @type memory
    flush_interval 1s
  </buffer>
</match>

<match docker.web-frontend.**>
  @type file
  path /fluentd/log/services/web-frontend
  append true
  <format>
    @type json
  </format>
  <buffer>
    @type memory
    flush_interval 1s
  </buffer>
</match>

# Infrastructure logs
<match docker.postgres.**>
  @type file
  path /fluentd/log/infrastructure/postgres
  append true
  <format>
    @type json
  </format>
  <buffer>
    @type memory
    flush_interval 1s
  </buffer>
</match>

<match docker.redis.**>
  @type file
  path /fluentd/log/infrastructure/redis
  append true
  <format>
    @type json
  </format>
  <buffer>
    @type memory
    flush_interval 1s
  </buffer>
</match>

# Error logs
<match **error**>
  @type file
  path /fluentd/log/errors/application-errors
  append true
  <format>
    @type json
  </format>
  <buffer>
    @type memory
    flush_interval 1s
  </buffer>
</match>

# Performance logs
<match **performance**>
  @type file
  path /fluentd/log/performance/response-times
  append true
  <format>
    @type json
  </format>
  <buffer>
    @type memory
    flush_interval 1s
  </buffer>
</match>

# Health check logs
<match **health**>
  @type file
  path /fluentd/log/run/health
  append true
  <format>
    @type json
  </format>
  <buffer>
    @type memory
    flush_interval 1s
  </buffer>
</match>

# Catch-all for any unmatched logs
<match **>
  @type file
  path /fluentd/log/run/general
  append true
  <format>
    @type json
  </format>
  <buffer>
    @type memory
    flush_interval 1s
  </buffer>
</match>
