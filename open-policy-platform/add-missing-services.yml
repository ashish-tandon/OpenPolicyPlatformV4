# Missing services to be added to docker-compose.complete.yml

  # ========================================
  # BACKGROUND TASK PROCESSING
  # ========================================
  
  # Celery Worker - Background task processing
  celery-worker:
    build:
      context: ./services/scraper-service
      dockerfile: Dockerfile
    command: celery -A celery_tasks worker --loglevel=info
    environment:
      - DATABASE_URL=postgresql://openpolicy:openpolicy123@postgres:5432/openpolicy
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    volumes:
      - ./scrapers-data:/app/scrapers-data
      - ./logs/celery:/app/logs
    depends_on:
      - postgres
      - redis
      - fluentd
    networks:
      - openpolicy-network
    logging:
      driver: "fluentd"
      options:
        fluentd-address: "localhost:24224"
        tag: "celery-worker.{{.Name}}"
        fluentd-async: "true"
        fluentd-retry-wait: "1s"
        fluentd-max-retries: "30"

  # Celery Beat - Scheduled task scheduler
  celery-beat:
    build:
      context: ./services/scraper-service
      dockerfile: Dockerfile
    command: celery -A celery_tasks beat --loglevel=info
    environment:
      - DATABASE_URL=postgresql://openpolicy:openpolicy123@postgres:5432/openpolicy
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    volumes:
      - ./logs/celery:/app/logs
    depends_on:
      - postgres
      - redis
      - fluentd
    networks:
      - openpolicy-network
    logging:
      driver: "fluentd"
      options:
        fluentd-address: "localhost:24224"
        tag: "celery-beat.{{.Name}}"
        fluentd-async: "true"
        fluentd-retry-wait: "1s"
        fluentd-max-retries: "30"

  # Flower - Celery monitoring UI
  flower:
    build:
      context: ./services/scraper-service
      dockerfile: Dockerfile
    command: celery -A celery_tasks flower --port=5555
    ports:
      - "5555:5555"
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    depends_on:
      - redis
      - celery-worker
      - celery-beat
      - fluentd
    networks:
      - openpolicy-network
    logging:
      driver: "fluentd"
      options:
        fluentd-address: "localhost:24224"
        tag: "flower.{{.Name}}"
        fluentd-async: "true"
        fluentd-retry-wait: "1s"
        fluentd-max-retries: "30"

  # Scraper Runner - Background scraper execution
  scraper-runner:
    build:
      context: ./services/scraper-service
      dockerfile: Dockerfile
    command: python continuous_monitoring.py
    environment:
      - DATABASE_URL=postgresql://openpolicy:openpolicy123@postgres:5432/openpolicy
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
    volumes:
      - ./scrapers-data:/app/scrapers-data
      - ./logs/scraper-runner:/app/logs
    depends_on:
      - postgres
      - redis
      - celery-worker
      - fluentd
    networks:
      - openpolicy-network
    logging:
      driver: "fluentd"
      options:
        fluentd-address: "localhost:24224"
        tag: "scraper-runner.{{.Name}}"
        fluentd-async: "true"
        fluentd-retry-wait: "1s"
        fluentd-max-retries: "30"

  # Nginx Gateway - Reverse proxy and load balancer
  gateway:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./logs/nginx:/var/log/nginx
    depends_on:
      - api-gateway
      - web
      - fluentd
    networks:
      - openpolicy-network
    logging:
      driver: "fluentd"
      options:
        fluentd-address: "localhost:24224"
        tag: "gateway.{{.Name}}"
        fluentd-async: "true"
        fluentd-retry-wait: "1s"
        fluentd-max-retries: "30"