# Open Policy Platform V4 - Optimized PostgreSQL Configuration
# Optimized for performance and resource efficiency

# ========================================
# CONNECTION SETTINGS
# ========================================
max_connections = 100                    # Optimal for our platform
superuser_reserved_connections = 3       # Reserve connections for admin
unix_socket_directories = '/var/run/postgresql'

# ========================================
# MEMORY SETTINGS (OPTIMIZED)
# ========================================
shared_buffers = 256MB                   # Increased from 128MB (2x improvement)
effective_cache_size = 4GB               # Keep optimal setting
work_mem = 8MB                           # Increased from 4MB (2x improvement)
maintenance_work_mem = 64MB              # Increased for better maintenance
autovacuum_work_mem = 64MB              # Better autovacuum performance

# ========================================
# WRITE-AHEAD LOG SETTINGS
# ========================================
wal_buffers = 16MB                       # Optimized for our workload
checkpoint_completion_target = 0.9       # Smooth checkpoint completion
checkpoint_timeout = 5min                # Reasonable checkpoint interval
max_wal_size = 1GB                       # Adequate WAL size

# ========================================
# QUERY PLANNER SETTINGS
# ========================================
random_page_cost = 1.1                   # Optimized for SSD storage
effective_io_concurrency = 200           # Better I/O parallelism
default_statistics_target = 100          # Better query planning

# ========================================
# AUTOVACUUM SETTINGS
# ========================================
autovacuum = on                          # Enable autovacuum
autovacuum_max_workers = 3               # Optimal worker count
autovacuum_naptime = 1min                # Frequent autovacuum
autovacuum_vacuum_threshold = 50         # Lower threshold for better maintenance
autovacuum_analyze_threshold = 50        # Lower threshold for better statistics

# ========================================
# LOGGING SETTINGS
# ========================================
log_destination = 'stderr'               # Container-friendly logging
logging_collector = off                  # Disable for container environment
log_min_duration_statement = 1000        # Log slow queries (>1s)
log_checkpoints = on                     # Monitor checkpoint performance
log_connections = off                    # Reduce log noise
log_disconnections = off                 # Reduce log noise

# ========================================
# PERFORMANCE TUNING
# ========================================
synchronous_commit = on                  # Data durability
fsync = on                               # Data durability
full_page_writes = on                    # Data durability
bgwriter_delay = 200ms                   # Background writer timing
bgwriter_lru_maxpages = 100             # Background writer efficiency

# ========================================
# CONNECTION POOLING OPTIMIZATION
# ========================================
tcp_keepalives_idle = 600               # Keep connections alive
tcp_keepalives_interval = 30            # Keep connections alive
tcp_keepalives_count = 3                # Keep connections alive

# ========================================
# QUERY OPTIMIZATION
# ========================================
enable_seqscan = on                      # Enable sequential scans when needed
enable_indexscan = on                    # Enable index scans
enable_bitmapscan = on                   # Enable bitmap scans
enable_hashjoin = on                     # Enable hash joins
enable_mergejoin = on                    # Enable merge joins
enable_nestloop = on                     # Enable nested loop joins

# ========================================
# STATISTICS SETTINGS
# ========================================
track_activities = on                    # Track query activities
track_counts = on                        # Track table and index counts
track_io_timing = on                     # Track I/O timing
track_functions = all                    # Track function calls

# ========================================
# LOCK MANAGEMENT
# ========================================
deadlock_timeout = 1s                    # Quick deadlock detection
max_locks_per_transaction = 64           # Adequate lock limit

# ========================================
# REPLICATION SETTINGS (FOR FUTURE USE)
# ========================================
wal_level = replica                      # Enable WAL archiving
max_wal_senders = 3                      # Future replication support
max_replication_slots = 3                # Future replication support

# ========================================
# SECURITY SETTINGS
# ========================================
ssl = off                                # Disable SSL for container environment
password_encryption = scram-sha-256      # Secure password encryption
