name: ğŸ”„ Repository Synchronization & Multi-Environment Deployment

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'repositories/**'
      - '.github/workflows/repository-sync.yml'
      - 'environments/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to sync to'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - dev
        - test
        - prod

env:
  DEV_ENVIRONMENT: "laptop"
  TEST_ENVIRONMENT: "qnap-staging"
  PROD_ENVIRONMENT: "azure-production"
  REPO_SYNC_TOKEN: ${{ secrets.REPO_SYNC_TOKEN }}

jobs:
  sync-repositories:
    name: ğŸ”„ Sync All Repositories
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout main repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.REPO_SYNC_TOKEN }}
        
    - name: ğŸ”„ Sync core repository
      run: |
        echo "ğŸ”„ Syncing core repository..."
        # Sync to openpolicy-platform-v5-core
        # This will trigger CI/CD in the core repo
        
    - name: ğŸ”„ Sync services repository
      run: |
        echo "ğŸ”„ Syncing services repository..."
        # Sync to openpolicy-platform-v5-services
        # This will trigger CI/CD in the services repo
        
    - name: ğŸ”„ Sync web repository
      run: |
        echo "ğŸ”„ Syncing web repository..."
        # Sync to openpolicy-platform-v5-web
        # This will trigger CI/CD in the web repo
        
    - name: ğŸ”„ Sync monitoring repository
      run: |
        echo "ğŸ”„ Syncing monitoring repository..."
        # Sync to openpolicy-platform-v5-monitoring
        # This will trigger CI/CD in the monitoring repo
        
    - name: ğŸ”„ Sync deployment repository
      run: |
        echo "ğŸ”„ Syncing deployment repository..."
        # Sync to openpolicy-platform-v5-deployment
        # This will trigger CI/CD in the deployment repo
        
    - name: ğŸ”„ Sync docs repository
      run: |
        echo "ğŸ”„ Syncing docs repository..."
        # Sync to openpolicy-platform-v5-docs
        # This will trigger CI/CD in the docs repo

  deploy-dev:
    name: ğŸ–¥ï¸ Deploy to Dev (Laptop)
    runs-on: ubuntu-latest
    needs: [sync-repositories]
    if: github.ref == 'refs/heads/develop' || github.event.inputs.environment == 'dev' || github.event.inputs.environment == 'all'
    # environment: development
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Setup SSH for Dev
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.DEV_SSH_PRIVATE_KEY }}
        
    - name: ğŸš€ Deploy to Dev Laptop
      run: |
        echo "ğŸ–¥ï¸ Deploying to Dev environment (Laptop)..."
        # SSH to laptop and deploy
        ssh ${{ secrets.DEV_SSH_USER }}@${{ secrets.DEV_SSH_HOST }} << 'EOF'
          cd /path/to/openpolicy-platform
          git pull origin develop
          docker-compose -f docker-compose.complete.yml down
          docker-compose -f docker-compose.complete.yml up -d
          echo "âœ… Dev deployment complete!"
        EOF
        
    - name: ğŸ” Dev Health Check
      run: |
        echo "ğŸ” Running Dev health checks..."
        # Health check commands for dev environment

  deploy-test:
    name: ğŸ§ª Deploy to Test (QNAP)
    runs-on: ubuntu-latest
    needs: [sync-repositories]
    if: github.ref == 'refs/heads/develop' || github.event.inputs.environment == 'test' || github.event.inputs.environment == 'all'
    # environment: staging
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Setup SSH for QNAP
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.QNAP_SSH_PRIVATE_KEY }}
        
    - name: ğŸš€ Deploy to QNAP Staging
      run: |
        echo "ğŸ§ª Deploying to Test environment (QNAP)..."
        # SSH to QNAP and deploy
        ssh ${{ secrets.QNAP_SSH_USER }}@${{ secrets.QNAP_SSH_HOST }} << 'EOF'
          cd /share/Container/openpolicy-platform
          git pull origin develop
          docker-compose -f docker-compose.complete.yml down
          docker-compose -f docker-compose.complete.yml up -d
          echo "âœ… Test deployment complete!"
        EOF
        
    - name: ğŸ” Test Health Check
      run: |
        echo "ğŸ” Running Test health checks..."
        # Health check commands for QNAP environment

  deploy-prod:
    name: ğŸš€ Deploy to Production (Azure)
    runs-on: ubuntu-latest
    needs: [sync-repositories]
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'prod' || github.event.inputs.environment == 'all'
    # environment: production
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Setup Azure credentials
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: ğŸš€ Deploy to Azure Production
      run: |
        echo "ğŸš€ Deploying to Production environment (Azure)..."
        # Azure deployment commands
        az aks get-credentials --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} --name ${{ secrets.AZURE_AKS_CLUSTER }}
        kubectl apply -f k8s/production/
        kubectl rollout restart deployment/openpolicy-platform
        
    - name: ğŸ” Production Health Check
      run: |
        echo "ğŸ” Running Production health checks..."
        # Health check commands for Azure environment
        
    - name: ğŸ·ï¸ Create Production Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ github.run_number }}
        release_name: Production Release v${{ github.run_number }}
        draft: false
        prerelease: false
